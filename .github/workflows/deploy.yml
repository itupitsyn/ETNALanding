name: Deploy Next.js (Bun Runtime) via SCP

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Save Image (Compressed)
        run: |
          docker build -t etna-landing .
          # Сжимаем образ "на лету" для уменьшения размера файла
          docker save etna-landing | gzip > etna-landing.tar.gz

      - name: Copy image to VDS
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          password: ${{ secrets.VDS_PASSWORD }}
          port: 52
          source: "etna-landing.tar.gz"
          target: "/tmp"

      - name: Load and Restart with Bun
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          password: ${{ secrets.VDS_PASSWORD }}
          port: 52
          script: |
            # Распаковываем и загружаем образ
            zcat /tmp/etna-landing.tar.gz | docker load
            
            # Удаляем старый контейнер
            docker stop etna-landing || true
            docker rm etna-landing || true
            
            # Запускаем новый
            docker run -d \
              --name etna-landing \
              --restart always \
              -p 3500:3000 \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              etna-landing
            
            # Очистка
            rm /tmp/etna-landing.tar.gz
            docker image prune -f
